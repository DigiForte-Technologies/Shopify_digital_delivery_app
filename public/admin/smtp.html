<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SMTP Settings - Shopify Digital Downloads Admin</title>
  <link rel="stylesheet" href="../css/auth.css">
  <link rel="stylesheet" href="../css/admin.css">
</head>
<body class="dashboard-body">
  <div class="dashboard-container">
    <div class="sidebar">
      <div class="logo">
        <div class="logo-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4" />
            <path d="M3 5v14a2 2 0 0 0 2 2h16v-5" />
            <path d="M18 12a2 2 0 0 0 0 4h4v-4Z" />
          </svg>
        </div>
        <span class="logo-text">Shopify Digital</span>
      </div>
      
      <nav class="nav-menu">
        <a href="/admin/home" class="nav-item">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
          <span>Home</span>
        </a>
        <a href="/admin/assets" class="nav-item">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
            <line x1="12" y1="22.08" x2="12" y2="12"></line>
          </svg>
          <span>Assets</span>
        </a>
        <a href="/admin/products" class="nav-item">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
          </svg>
          <span>Products</span>
        </a>
        <a href="/admin/email-editor" class="nav-item">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          <span>Email Template</span>
        </a>
        <a href="/admin/smtp" class="nav-item active">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
            <line x1="8" y1="21" x2="16" y2="21"></line>
            <line x1="12" y1="17" x2="12" y2="21"></line>
          </svg>
          <span>SMTP Settings</span>
        </a>
        <a href="/admin/orders" class="nav-item">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <line x1="8" y1="6" x2="21" y2="6"></line>
            <line x1="8" y1="12" x2="21" y2="12"></line>
            <line x1="8" y1="18" x2="21" y2="18"></line>
            <line x1="3" y1="6" x2="3.01" y2="6"></line>
            <line x1="3" y1="12" x2="3.01" y2="12"></line>
            <line x1="3" y1="18" x2="3.01" y2="18"></line>
          </svg>
          <span>Orders</span>
        </a>
        <div class="nav-divider"></div>
        <a href="/logout" class="nav-item logout">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          <span>Logout</span>
        </a>
      </nav>
    </div>

    <div class="main-content">
      <div class="header">
        <div class="welcome-message">
          <h1>SMTP Settings</h1>
          <p class="store-url">Configure your email delivery settings</p>
        </div>
      </div>

      <div class="login-card" style="max-width: 600px; margin: 0 auto;">
        <form id="smtpForm" class="login-form">
          <div class="form-group">
            <label for="host">SMTP Host</label>
            <div class="input-wrapper">
              <div class="input-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                  <path d="M8 21h8"></path>
                  <path d="M12 17v4"></path>
                </svg>
              </div>
              <input type="text" id="host" name="host" placeholder="e.g. smtp.gmail.com" required>
            </div>
          </div>

          <div class="form-group">
            <label for="port">SMTP Port</label>
            <div class="input-wrapper">
              <div class="input-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                  <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
              </div>
              <input type="number" id="port" name="port" placeholder="e.g. 587" required>
            </div>
          </div>

          <div class="form-group">
            <label for="user">Username</label>
            <div class="input-wrapper">
              <div class="input-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
              </div>
              <input type="text" id="user" name="user" placeholder="Your SMTP username" required>
            </div>
          </div>

          <div class="form-group">
            <label for="pass">Password</label>
            <div class="input-wrapper">
              <div class="input-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>
                </svg>
              </div>
              <input type="password" id="pass" name="pass" placeholder="Your SMTP password" required>
              <button type="button" class="toggle-password" aria-label="Toggle password visibility">
                <svg class="eye-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <svg class="eye-off-icon hidden" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                  <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
              </button>
            </div>
            <div class="form-group">
              <label for="fromAddress">From Address</label>
              <div class="input-wrapper">
                <div class="input-icon">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                    <polyline points="22,6 12,13 2,6"></polyline>
                  </svg>
                </div>
                <input type="email" id="fromAddress" name="fromAddress" placeholder="e.g. no-reply@yourstore.com" required>
              </div>
            </div>
            
          </div>
          
          <!-- <div class="form-group">
            <label>
              <input type="checkbox" id="secureConnection"> Use Secure Connection (TLS/SSL)
            </label>
          </div> -->

          <button type="submit" class="submit-button">Save SMTP Settings</button>
          
          <div id="smtpResult" class="smtp-result"></div>
        </form>
        
        <div class="form-group" style="margin-top: 24px; text-align: center;">
          <button id="testConnection" class="submit-button" style="background-color: #64748b;">Test Connection</button>
        </div>
      </div>

      <div class="recent-activity" style="margin-top: 30px;">
        <h2>SMTP Configuration Tips</h2>
        <div class="activity-list">
          <div class="activity-item">
            <div class="activity-icon email">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
              </svg>
            </div>
            <div class="activity-details">
              <p class="activity-text">For Gmail, use <strong>smtp.gmail.com</strong> with port <strong>587</strong> and enable TLS</p>
            </div>
          </div>
          <div class="activity-item">
            <div class="activity-icon email">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
              </svg>
            </div>
            <div class="activity-details">
              <p class="activity-text">If using Gmail, you may need to <a href="https://myaccount.google.com/apppasswords" target="_blank">create an app password</a></p>
            </div>
          </div>
          <div class="activity-item">
            <div class="activity-icon email">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
              </svg>
            </div>
            <div class="activity-details">
              <p class="activity-text">For Outlook/Office 365, use <strong>smtp.office365.com</strong> with port <strong>587</strong></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .smtp-result {
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
      display: none;
    }
    
    .smtp-result.success {
      background-color: rgba(16, 185, 129, 0.1);
      color: #10b981;
      display: block;
    }
    
    .smtp-result.error {
      background-color: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      display: block;
    }
    
    .input-loading {
      opacity: 0.7;
      pointer-events: none;
    }
    
    .submit-button.loading {
      position: relative;
      color: transparent;
    }
    
    .submit-button.loading::after {
      content: "";
      position: absolute;
      width: 20px;
      height: 20px;
      top: 50%;
      left: 50%;
      margin: -10px 0 0 -10px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>

  <script>
    // Set current year in footer
    document.addEventListener('DOMContentLoaded', function() {
      // Load SMTP settings
      fetch('/admin/api/smtp')
        .then(res => res.json())
        .then(data => {
          if (data.smtp) {
            document.getElementById('host').value = data.smtp.host || '';
            document.getElementById('port').value = data.smtp.port || '';
            document.getElementById('user').value = data.smtp.user || '';
            document.getElementById('pass').value = data.smtp.pass || '';
            document.getElementById('fromAddress').value = data.smtp.from_address || '';

            
            // // If secure is defined, set the checkbox
            // if (data.smtp.secure !== undefined) {
            //   document.getElementById('secureConnection').checked = data.smtp.secure;
            // }
          }
        })
        .catch(err => {
          console.error('Error fetching SMTP settings:', err);
          showResult('Error loading SMTP settings. Please try again.', 'error');
        });
      
      // Form submission
      document.getElementById('smtpForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitButton = this.querySelector('.submit-button');
        submitButton.classList.add('loading');
        
        const host = document.getElementById('host').value;
        const port = document.getElementById('port').value;
        const user = document.getElementById('user').value;
        const pass = document.getElementById('pass').value;
        const fromAddress = document.getElementById('fromAddress').value;

        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(fromAddress)) {
          alert("Please enter a valid 'From Address' email.");
          submitButton.classList.remove('loading');
          return;
        }

        try {
          const response = await fetch('/admin/api/smtp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ host, port, user, pass, fromAddress })
          });

          const result = await response.json();
          
          if (response.ok) {
            showResult(result.message || 'SMTP settings saved successfully!', 'success');
          } else {
            showResult(result.message || 'Error saving SMTP settings.', 'error');
          }
        } catch (err) {
          console.error('Error saving SMTP settings:', err);
          showResult('Network error. Please try again.', 'error');
        } finally {
          submitButton.classList.remove('loading');
        }
      });
      
      // Test connection button
      document.getElementById('testConnection').addEventListener('click', async function() {
        this.classList.add('loading');
        
        try {
          const response = await fetch('/admin/api/smtp/test', {
            method: 'POST'
          });
          
          const result = await response.json();
          
          if (response.ok) {
            showResult(result.message || 'Connection test successful!', 'success');
          } else {
            showResult(result.message || 'Connection test failed.', 'error');
          }
        } catch (err) {
          console.error('Error testing connection:', err);
          showResult('Network error. Please try again.', 'error');
        } finally {
          this.classList.remove('loading');
        }
      });
      
      // Toggle password visibility
      document.querySelector('.toggle-password').addEventListener('click', function() {
        const passwordInput = document.getElementById('pass');
        const eyeIcon = document.querySelector('.eye-icon');
        const eyeOffIcon = document.querySelector('.eye-off-icon');
        
        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          eyeIcon.classList.add('hidden');
          eyeOffIcon.classList.remove('hidden');
        } else {
          passwordInput.type = 'password';
          eyeIcon.classList.remove('hidden');
          eyeOffIcon.classList.add('hidden');
        }
      });
      
      // Make nav items clickable
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach(item => {
        item.addEventListener('click', function(e) {
          // This is just for the demo, in a real app the page would navigate
          navItems.forEach(i => i.classList.remove('active'));
          this.classList.add('active');
        });
      });
    });
    
    function showResult(message, type) {
      const resultElement = document.getElementById('smtpResult');
      resultElement.innerText = message;
      resultElement.className = 'smtp-result';
      resultElement.classList.add(type);
      
      // Hide the message after 5 seconds
      setTimeout(() => {
        resultElement.style.display = 'none';
        setTimeout(() => {
          resultElement.className = 'smtp-result';
        }, 300);
      }, 5000);
    }
    document.getElementById('testConnection').addEventListener('click', async function() {
    this.classList.add('loading');

    try {
        const response = await fetch('/admin/api/smtp/test', { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            showResult(result.message || 'SMTP connection successful!', 'success');
        } else {
            showResult(result.message || 'SMTP connection failed.', 'error');
        }
    } catch (err) {
        console.error('Error testing connection:', err);
        showResult('Network error. Please try again.', 'error');
    } finally {
        this.classList.remove('loading');
    }
});

  </script>
</body>
</html>